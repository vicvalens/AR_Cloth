<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>WebAR POC - Cámara + Playera Overlay</title>
  <style>
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background: #000; color:#fff; }
    .app { height: 100vh; display: grid; grid-template-rows: auto 1fr auto; }
    header { padding: 12px 12px 6px; display:flex; justify-content:space-between; align-items:center; gap:10px; }
    header h1 { font-size: 16px; margin: 0; font-weight: 650; }
    header .badge { font-size: 12px; border: 1px solid rgba(255,255,255,0.25); padding: 4px 8px; border-radius: 999px; opacity: 0.9; }

    .stage { position: relative; overflow: hidden; }
    video, canvas { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; }
    canvas { touch-action: none; }

    .panel {
      padding: 10px 12px 14px;
      background: linear-gradient(to top, rgba(0,0,0,0.85), rgba(0,0,0,0.3));
      display: grid;
      gap: 10px;
    }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    label { font-size: 12px; opacity: 0.9; display:grid; gap: 6px; }
    input[type="range"] { width: 100%; }
    .btns { display:flex; gap: 10px; flex-wrap: wrap; }
    button {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.25);
      background: rgba(255,255,255,0.06);
      color: #fff;
      cursor: pointer;
      font-weight: 600;
    }
    button:active { transform: translateY(1px); }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .hint { font-size: 12px; opacity: 0.8; line-height: 1.3; }
  </style>
</head>

<body>
<div class="app">
  <header>
    <h1>WebAR POC — Cámara + Playera</h1>
    <span class="badge" id="status">Listo</span>
  </header>

  <div class="stage">
    <video id="video" playsinline muted></video>
    <canvas id="canvas"></canvas>
  </div>

  <div class="panel">
    <div class="row">
      <label>
        Escala
        <input id="scale" type="range" min="0.3" max="2.2" value="1" step="0.01" />
      </label>
      <label>
        Rotación (°)
        <input id="rot" type="range" min="-35" max="35" value="0" step="0.5" />
      </label>
    </div>

    <div class="row">
      <label>
        Opacidad
        <input id="opacity" type="range" min="0.1" max="1" value="0.95" step="0.01" />
      </label>
      <label>
        “Altura” (Y)
        <input id="y" type="range" min="-300" max="300" value="0" step="1" />
      </label>
    </div>

    <div class="btns">
      <button id="startBtn">Activar cámara</button>
      <button id="flipBtn" disabled>Cambiar cámara</button>
      <button id="centerBtn" disabled>Centrar prenda</button>
      <button id="snapBtn" disabled>Snapshot</button>
      <button id="resetBtn">Reset</button>
    </div>

    <div class="hint">
      Tip: abre desde HTTPS (GitHub Pages). Arrastra la playera con el dedo. Esto es AR básico (overlay), sin tracking automático aún.
    </div>
  </div>
</div>

<script>
  // Error overlay para no quedarnos en negro sin explicación
  window.addEventListener("error", (e) => {
    const msg = (e && (e.message || (e.error && e.error.message))) || "Unknown error";
    document.body.innerHTML =
      "<pre style='padding:12px;white-space:pre-wrap;font:14px system-ui;color:#ffb4b4;background:#200'>" +
      "JS Error: " + msg +
      "</pre>";
  });

  const statusEl = document.getElementById("status");
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");

  const startBtn = document.getElementById("startBtn");
  const flipBtn = document.getElementById("flipBtn");
  const centerBtn = document.getElementById("centerBtn");
  const snapBtn = document.getElementById("snapBtn");
  const resetBtn = document.getElementById("resetBtn");

  const scaleEl = document.getElementById("scale");
  const rotEl = document.getElementById("rot");
  const opacityEl = document.getElementById("opacity");
  const yEl = document.getElementById("y");

  function setStatus(t) { statusEl.textContent = t; }

  // Canvas resolution match
  function resizeCanvasToDisplaySize() {
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const rect = canvas.getBoundingClientRect();
    const w = Math.round(rect.width * dpr);
    const h = Math.round(rect.height * dpr);
    if (canvas.width !== w || canvas.height !== h) {
      canvas.width = w;
      canvas.height = h;
    }
  }

  // Load garment PNG
  const garmentImg = new Image();
  garmentImg.src = "shirt.png"; // coloca tu PNG aquí
  garmentImg.onload = () => draw();
  garmentImg.onerror = () => setStatus("No cargó shirt.png");

  // Garment state in canvas coords (pixels)
  const garment = {
    x: 0, y: 0,
    scale: parseFloat(scaleEl.value),
    rotDeg: parseFloat(rotEl.value),
    opacity: parseFloat(opacityEl.value),
    baseW: 520, // ajusta según tu PNG
    baseH: 600
  };

  // Manual drag
  let dragging = false;
  let dragOffsetX = 0, dragOffsetY = 0;

  function getPointerPos(ev) {
    const rect = canvas.getBoundingClientRect();
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const x = (ev.clientX - rect.left) * dpr;
    const y = (ev.clientY - rect.top) * dpr;
    return { x, y };
  }

  function isOverGarment(px, py) {
    const w = garment.baseW * garment.scale;
    const h = garment.baseH * garment.scale;
    // hit test simple (sin rotación)
    return (px >= garment.x - w/2 && px <= garment.x + w/2 &&
            py >= garment.y - h/2 && py <= garment.y + h/2);
  }

  canvas.addEventListener("pointerdown", (ev) => {
    canvas.setPointerCapture(ev.pointerId);
    const p = getPointerPos(ev);
    if (isOverGarment(p.x, p.y)) {
      dragging = true;
      dragOffsetX = p.x - garment.x;
      dragOffsetY = p.y - garment.y;
    }
  });

  canvas.addEventListener("pointermove", (ev) => {
    if (!dragging) return;
    const p = getPointerPos(ev);
    garment.x = p.x - dragOffsetX;
    garment.y = p.y - dragOffsetY;
    draw();
  });

  canvas.addEventListener("pointerup", () => dragging = false);
  canvas.addEventListener("pointercancel", () => dragging = false);

  // Camera
  let stream = null;
  let usingFront = true;

  async function startCamera() {
    setStatus("Pidiendo cámara…");
    stopCamera();

    const constraints = {
      audio: false,
      video: {
        facingMode: usingFront ? "user" : "environment",
        width: { ideal: 1280 },
        height: { ideal: 720 }
      }
    };

    stream = await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject = stream;
    await video.play();

    setStatus(usingFront ? "Cámara frontal" : "Cámara trasera");
    flipBtn.disabled = false;
    centerBtn.disabled = false;
    snapBtn.disabled = false;

    // Center garment when camera starts
    centerGarment();
    drawLoop();
  }

  function stopCamera() {
    if (stream) {
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }
  }

  function centerGarment() {
    resizeCanvasToDisplaySize();
    garment.x = canvas.width * 0.5;
    garment.y = canvas.height * 0.52 + parseFloat(yEl.value);
    draw();
  }

  // Drawing
  function drawVideoFrame() {
    resizeCanvasToDisplaySize();

    // draw video into canvas (cover)
    const cw = canvas.width, ch = canvas.height;
    const vw = video.videoWidth || 0;
    const vh = video.videoHeight || 0;
    if (!vw || !vh) return;

    const s = Math.max(cw / vw, ch / vh);
    const nw = vw * s;
    const nh = vh * s;
    const dx = (cw - nw) / 2;
    const dy = (ch - nh) / 2;

    // Mirror for front camera so it feels like a mirror
    ctx.save();
    if (usingFront) {
      ctx.translate(cw, 0);
      ctx.scale(-1, 1);
      ctx.drawImage(video, dx, dy, nw, nh);
    } else {
      ctx.drawImage(video, dx, dy, nw, nh);
    }
    ctx.restore();
  }

  function drawGarment() {
    if (!garmentImg.complete || garmentImg.naturalWidth === 0) return;

    ctx.save();
    ctx.globalAlpha = garment.opacity;

    // If front camera is mirrored, mirror garment too so it stays aligned visually
    const cw = canvas.width;
    if (usingFront) {
      ctx.translate(cw, 0);
      ctx.scale(-1, 1);
      // Convert x for mirrored space
      const mx = cw - garment.x;

      const rot = garment.rotDeg * Math.PI / 180;
      ctx.translate(mx, garment.y);
      ctx.rotate(rot);
      ctx.scale(garment.scale, garment.scale);
      ctx.drawImage(garmentImg, -garment.baseW/2, -garment.baseH/2, garment.baseW, garment.baseH);
    } else {
      const rot = garment.rotDeg * Math.PI / 180;
      ctx.translate(garment.x, garment.y);
      ctx.rotate(rot);
      ctx.scale(garment.scale, garment.scale);
      ctx.drawImage(garmentImg, -garment.baseW/2, -garment.baseH/2, garment.baseW, garment.baseH);
    }

    ctx.restore();
    ctx.globalAlpha = 1;
  }

  function draw() {
    if (!stream) {
      // if no camera, show placeholder
      resizeCanvasToDisplaySize();
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = "#111";
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = "rgba(255,255,255,0.85)";
      ctx.font = "24px system-ui";
      ctx.fillText("Pulsa “Activar cámara”", 40, 70);
      return;
    }
    drawVideoFrame();
    drawGarment();
  }

  let rafId = null;
  function drawLoop() {
    cancelAnimationFrame(rafId);
    const tick = () => {
      draw();
      rafId = requestAnimationFrame(tick);
    };
    tick();
  }

  // UI bindings
  startBtn.addEventListener("click", async () => {
    try {
      if (!navigator.mediaDevices?.getUserMedia) {
        alert("Este navegador no soporta getUserMedia.");
        return;
      }
      await startCamera();
    } catch (err) {
      console.error(err);
      setStatus("Error cámara");
      alert("No pude acceder a la cámara. Verifica permisos y que sea HTTPS.");
    }
  });

  flipBtn.addEventListener("click", async () => {
    usingFront = !usingFront;
    await startCamera();
  });

  centerBtn.addEventListener("click", centerGarment);

  resetBtn.addEventListener("click", () => {
    scaleEl.value = 1;
    rotEl.value = 0;
    opacityEl.value = 0.95;
    yEl.value = 0;

    garment.scale = 1;
    garment.rotDeg = 0;
    garment.opacity = 0.95;
    centerGarment();
    setStatus(stream ? (usingFront ? "Cámara frontal" : "Cámara trasera") : "Listo");
  });

  scaleEl.addEventListener("input", () => { garment.scale = parseFloat(scaleEl.value); });
  rotEl.addEventListener("input", () => { garment.rotDeg = parseFloat(rotEl.value); });
  opacityEl.addEventListener("input", () => { garment.opacity = parseFloat(opacityEl.value); });
  yEl.addEventListener("input", () => { centerGarment(); });

  snapBtn.addEventListener("click", () => {
    // Take snapshot of current canvas
    const a = document.createElement("a");
    a.download = "webar_tryon.png";
    a.href = canvas.toDataURL("image/png");
    a.click();
  });

  // Initial placeholder render
  draw();

  // Cleanup
  window.addEventListener("beforeunload", () => stopCamera());
</script>
</body>
</html>
